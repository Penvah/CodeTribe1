(window.$WP=window.$WP||[]).push({id:"@ta/media.cropper",d:["vendor-babel","vendor-react-libs","ta-platform","ta-common","@ta/events.window-resize","@ta/input.slider"],e:["./packages/media/cropper/cropper-main.jsx"],x:{"./packages/media/cropper/cropper-main.jsx":["Cropper"]},m:{"./packages/media/cropper/cropper-main.jsx":function(e,t,o){"use strict";o.r(t);var a=o("@babel/runtime/helpers/esm/classCallCheck"),n=o.n(a),r=o("@babel/runtime/helpers/esm/createClass"),i=o.n(r),s=o("@babel/runtime/helpers/esm/possibleConstructorReturn"),c=o.n(s),p=o("@babel/runtime/helpers/esm/getPrototypeOf"),m=o.n(p),h=o("@babel/runtime/helpers/esm/inherits"),u=o.n(h),l=o("@babel/runtime/helpers/esm/assertThisInitialized"),g=o.n(l),d=o("@babel/runtime/helpers/esm/defineProperty"),v=o.n(d),f=o("react"),z=o("@ta/common.classnames"),w=o.n(z),S=o("@ta/styleguide.loading"),C=o("@ta/events.window-resize"),P=o.n(C),b=o("@ta/input.slider"),I=o("@ta/media.common"),M={canvasWrapper:"media-cropper-Cropper__canvasWrapper--1M93f",canvas:"media-cropper-Cropper__canvas--1A8wq",cropShadow:"media-cropper-Cropper__cropShadow--VUz9J",loadingSpinner:"media-cropper-Cropper__loadingSpinner--3dZci",zoomWrap:"media-cropper-Cropper__zoomWrap--2_SEM",zoomIconSmall:"media-cropper-Cropper__zoomIconSmall--1tVzo",zoomIconBig:"media-cropper-Cropper__zoomIconBig--36vYF",zoomSlider:"media-cropper-Cropper__zoomSlider--HI97U"},D=100,E=function(e){function t(e){var o;return n()(this,t),o=c()(this,m()(t).call(this,e)),v()(g()(g()(o)),"setImage",function(){o.props.url&&(o.image=new Image,o.image.onload=o.imageLoaded,o.image.crossOrigin="Anonymous",o.image.src=o.props.url)}),v()(g()(g()(o)),"canvasRef",f.createRef()),v()(g()(g()(o)),"image",void 0),v()(g()(g()(o)),"prevTouchPositions",new Map),v()(g()(g()(o)),"pinchInProgress",!1),v()(g()(g()(o)),"cropImage",function(){if(o.image){var e=o.state,t=e.cropCenter,a=e.cropSize,n=e.zoomCurrent,r=Math.round(t.x-a.width/2/n),i=Math.round(t.y-a.height/2/n),s=Math.round(a.width/n),c=Math.round(a.height/n),p={x:r,y:i,cropWidth:s,cropHeight:c,originalImageHeight:o.image.height,originalImageWidth:o.image.width},m=o.props,h=m.url,u=m.mimeType,l=m.cropImageCallback,g=Object(I.cropImageToJpegUrl)(o.image,u,r,i,s,c);Object(I.restoreExifAndRotateIfNeeded)(h,g,u,function(e){l({dataUrl:e,cropParams:p})})}}),v()(g()(g()(o)),"imageLoaded",function(){if(!o.canvasRef.current||!o.image)throw new Error("Image loaded, but refs are not set.  Should not be able to get here.");var e=new I.Dimension(o.image.width,o.image.height);o.setState({imageLoaded:!0,imageSize:e})}),v()(g()(g()(o)),"calculateCropSizeAndZoom",function(){if(!o.canvasRef.current||!o.image)throw new Error("Image loaded, but refs are not set.  Should not be able to get here.");var e,t=o.canvasRef.current,a=o.props,n=a.cropWidth,r=a.cropHeight,i=a.imageFitDirection,s=0===n?t.clientWidth:n,c=0===r?t.clientHeight:r,p=new I.Dimension(s,c),m=p.width/o.image.width,h=p.height/o.image.height;e="horizontal"===i?m:"vertical"===i?h:Math.max(m,h),o.image.height*e<p.height&&(e=h);var u=o.state.imageSize;return{cropSize:p,zoom:e,cropCenter:new I.Point(u.width/2,u.height/2)}}),v()(g()(g()(o)),"updateCanvas",function(){var e=o.state,t=e.canvasSize,a=e.imageSize,n=e.cropCenter,r=e.zoomCurrent;if(o.state.imageLoaded&&o.canvasRef.current&&o.image){var i=o.canvasRef.current,s=new I.Dimension(i.clientWidth,i.clientHeight);i.width=s.width,i.height=s.height;var c=Math.round(a.width*r),p=Math.round(a.height*r),m=s.width/2,h=s.height/2,u=Math.round(m-n.x*r),l=Math.round(h-n.y*r),g=i.getContext("2d");if(g.clearRect(0,0,s.width,s.height),g.drawImage(o.image,u,l,c,p),!t.equals(s)){var d=o.calculateCropSizeAndZoom();o.setState({canvasSize:s,cropSize:d.cropSize,zoomMin:d.zoom,zoomCurrent:d.zoom,cropCenter:d.cropCenter,zoomSliderValue:0})}}}),v()(g()(g()(o)),"mouseDown",function(e){o.props.enabled&&(e.preventDefault(),o.setState({isDragging:!0,prevPointerPosition:new I.Point(e.pageX,e.pageY)}))}),v()(g()(g()(o)),"stopDragging",function(){o.setState({isDragging:!1})}),v()(g()(g()(o)),"mouseMove",function(e){if(o.state.isDragging&&o.props.enabled){e.preventDefault();var t=o.state.prevPointerPosition,a=e.pageX-t.x,n=e.pageY-t.y;o.dragImage(a,n),o.setState({prevPointerPosition:new I.Point(e.pageX,e.pageY)})}}),v()(g()(g()(o)),"touchStart",function(e){o.props.enabled&&(e.preventDefault(),1===e.touches.length?o.saveSingleTouchPosition(e):2===e.touches.length&&(o.saveTouches(e),o.pinchInProgress=!0))}),v()(g()(g()(o)),"touchMove",function(e){o.props.enabled&&(e.preventDefault(),1===e.touches.length?o.touchDrag(e):2===e.touches.length&&o.props.allowZoom&&o.handlePinch(e))}),v()(g()(g()(o)),"saveSingleTouchPosition",function(e){var t=e.touches[0];o.setState({prevPointerPosition:new I.Point(t.pageX,t.pageY)})}),v()(g()(g()(o)),"touchDrag",function(e){var t=e.touches[0],a=o.state.prevPointerPosition,n=t.pageX-a.x,r=t.pageY-a.y;o.dragImage(n,r),o.saveSingleTouchPosition(e)}),v()(g()(g()(o)),"touchEnd",function(e){e.preventDefault(),1===e.touches.length&&o.saveSingleTouchPosition(e),1!==e.touches.length&&o.stopDragging(),2!==e.touches.length&&(o.pinchInProgress=!1)}),v()(g()(g()(o)),"touchCancel",function(){o.stopDragging(),o.pinchInProgress=!1}),v()(g()(g()(o)),"handlePinch",function(e){var t=e.touches[0],a=e.touches[1],n=new I.Point(t.pageX,t.pageY),r=new I.Point(a.pageX,a.pageY),i=o.prevTouchPositions.get(t.identifier),s=o.prevTouchPositions.get(a.identifier);if(i&&s){var c=n.distanceFrom(r),p=i.distanceFrom(s);if(p>0){var m=(c-p)/p,h=o.state,u=h.zoomCurrent,l=h.zoomMin,g=h.zoomMax,d=h.cropCenter,v=u+m*u;v=Object(I.boundNumber)(v,l,g);var f=o.zoomToSliderValue(v),z=o.adjustPointToKeepCropAreaFilled(d,v);o.setState({zoomCurrent:v,cropCenter:z,zoomSliderValue:f}),o.saveTouches(e)}}}),v()(g()(g()(o)),"saveTouches",function(e){Array.from(e.touches).forEach(function(e){return o.prevTouchPositions.set(e.identifier,new I.Point(e.pageX,e.pageY))})}),v()(g()(g()(o)),"dragImage",function(e,t){var a=o.state,n=a.cropCenter,r=a.zoomCurrent,i=e/r,s=t/r,c=new I.Point(n.x-i,n.y-s),p=o.adjustPointToKeepCropAreaFilled(c,r);o.setState({cropCenter:p})}),v()(g()(g()(o)),"adjustPointToKeepCropAreaFilled",function(e,t){var a=o.state,n=a.cropSize,r=a.imageSize,i=new I.Point(e.x,e.y),s=n.width/2/t,c=r.width-s,p=n.height/2/t,m=r.height-p;return i.x=Object(I.boundNumber)(i.x,s,c),i.y=Object(I.boundNumber)(i.y,p,m),i}),v()(g()(g()(o)),"zoomIncrement",function(){var e=o.state,t=e.zoomMin;return(e.zoomMax-t)/D}),v()(g()(g()(o)),"sliderValueToZoom",function(e){return o.state.zoomMin+o.zoomIncrement()*e}),v()(g()(g()(o)),"zoomToSliderValue",function(e){return(e-o.state.zoomMin)/o.zoomIncrement()}),v()(g()(g()(o)),"sliderChanged",function(e,t){if(!o.pinchInProgress){var a=t,n=o.sliderValueToZoom(a),r=o.state.cropCenter,i=o.adjustPointToKeepCropAreaFilled(r,n);o.setState({zoomSliderValue:a,zoomCurrent:n,cropCenter:i})}}),v()(g()(g()(o)),"render",function(){var e=o.props,t=e.cropShape,a=e.width,n=e.height,r=o.state,i=r.canvasSize,s=r.cropSize,c={width:s.width,height:s.height,top:(i.height-s.height)/2,left:(i.width-s.width)/2,borderRadius:"rectangle"===t?"0%":"100%"},p=o.state.imageLoaded?f.createElement("div",{style:c,className:M.cropShadow}):null,m=o.state.imageLoaded?null:f.createElement("div",{className:M.loadingSpinner},f.createElement(S.LoadingSpinner,{size:"large"})),h=o.props.allowZoom?f.createElement("div",{className:M.zoomWrap},f.createElement("span",{className:w()("ui_icon","photo",M.zoomIconSmall)}),f.createElement("div",{className:M.zoomSlider},f.createElement(b.Slider,{min:0,max:D-1,minHandleValue:0,maxHandleValue:o.state.zoomSliderValue,step:1,onChange:o.sliderChanged})),f.createElement("span",{className:"ui_icon photo ".concat(M.zoomIconBig)})):null;return f.createElement(f.Fragment,null,f.createElement("div",{style:{width:a,height:n},className:M.canvasWrapper},f.createElement("canvas",{className:M.canvas,ref:o.canvasRef,onMouseDown:o.mouseDown,onMouseUp:o.stopDragging,onMouseOut:o.stopDragging,onBlur:o.stopDragging,onMouseMove:o.mouseMove}),p,m),h,f.createElement(P.a,{callback:o.updateCanvas}))}),o.state={canvasSize:new I.Dimension(0,0),cropSize:new I.Dimension(0,0),imageLoaded:!1,imageSize:new I.Dimension(0,0),cropCenter:new I.Point(0,0),zoomMin:1,zoomMax:1,zoomCurrent:1,isDragging:!1,prevPointerPosition:new I.Point(0,0),zoomSliderValue:0},o}return u()(t,e),i()(t,[{key:"componentDidMount",value:function e(){if(this.setImage(),this.canvasRef.current){var t=this.canvasRef.current;t.addEventListener("touchstart",this.touchStart,{passive:!1}),t.addEventListener("touchmove",this.touchMove,{passive:!1}),t.addEventListener("touchend",this.touchEnd,{passive:!1}),t.addEventListener("touchcancel",this.touchCancel,{passive:!1})}}},{key:"componentDidUpdate",value:function e(t){t.url!==this.props.url?this.setImage():(this.updateCanvas(),this.props.cropImageNow&&this.cropImage())}}]),t}(f.Component);o.d(t,"Cropper",function(){return E})}}});
//# sourceMappingURL=media.cropper.d01e413404.js.map