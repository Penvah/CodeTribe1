(window.$WP=window.$WP||[]).push({id:"@ta/trips.trip-flow-selector",d:["vendor-babel","vendor-react-libs","@ta/overlays.toast","@ta/common.webview","ta-platform","@ta/social.login-gate","@ta/social.onboarding-state","@ta/trips.saver","@ta/trips.trip-types","@ta/trips.trip-constants","@ta/trips.tracking","@ta/trips.trip-util","@ta/trips.trip-toasts","@ta/common.localstorage","@ta/overlays.managers","@ta/overlays.modal","@ta/overlays.headers","vendor-apollo-libs","ta-common","@ta/trips.create-trip-modal","@ta/trips.save-to-trip-modal","@ta/trips.graphql"],e:["./packages/trips/trip-flow-selector/index.jsx"],x:{"./packages/trips/trip-flow-selector/index.jsx":["TripFlowSelector","QueriedTripFlowSelector","RemoteSTATModalProvider"]},m:{"./packages/trips/trip-flow-selector/index.jsx":function(e,t,n){"use strict";n.r(t);var a=n("@babel/runtime/helpers/esm/toConsumableArray"),o=n.n(a),r=n("@babel/runtime/helpers/esm/classCallCheck"),i=n.n(r),s=n("@babel/runtime/helpers/esm/createClass"),l=n.n(s),c=n("@babel/runtime/helpers/esm/possibleConstructorReturn"),p=n.n(c),u=n("@babel/runtime/helpers/esm/getPrototypeOf"),d=n.n(u),v=n("@babel/runtime/helpers/esm/inherits"),m=n.n(v),T=n("@babel/runtime/helpers/esm/assertThisInitialized"),f=n.n(T),h=n("@babel/runtime/helpers/esm/defineProperty"),S=n.n(h),C=n("react"),b=n("react-redux"),E=n("@ta/overlays.toast"),g=n("@ta/common.webview"),y=n("@ta/common.routing"),I=n("@ta/social.login-gate"),k=n("@ta/social.onboarding-state"),M=n("@ta/common.tracking"),A=n.n(M),O=n("@ta/common.features"),j=n("@ta/trips.saver"),_=n.n(j),P=(n("@ta/trips.trip-types"),n("@ta/trips.trip-constants")),L=n("@ta/trips.tracking"),w=n("@ta/trips.trip-util"),N=n("@ta/trips.trip-toasts"),R=n("@ta/common.localstorage"),D=n.n(R),F=n("@babel/runtime/helpers/esm/extends"),x=n.n(F),U=n("@babel/runtime/helpers/esm/objectSpread"),V=n.n(U),q=n("@ta/overlays.managers"),B=n("@ta/overlays.modal"),Q=n("@ta/overlays.headers"),G=n("react-apollo"),W=n("@ta/styleguide.loading"),z=n("@ta/loading.error"),X=n("@ta/common.i18n"),Y=n("@ta/trips.create-trip-modal"),H=n("@ta/trips.save-to-trip-modal"),$=n("@ta/trips.graphql"),Z=Object.freeze({DEFAULT:function e(){return Object(X.localize)("stat_modal_save_to_trip_v2")},CREATE:function e(){return Object(X.localize)("stat_modal_create_a_trip_v2")},SELECT:function e(){return Object(X.localize)("select_trip_header")},SELECT_CREATE:function e(){return Object(X.localize)("stat_modal_create_a_trip_v2")}}),J=function e(t){var n=Object($.selectQuery)("STAT_MODAL",t.placement);return C.createElement(G.Query,{query:null==n?void 0:n.query,displayName:null==n?void 0:n.displayName,notifyOnNetworkStatusChange:!0,fetchPolicy:"network-only",variables:{offset:0,limit:10,userId:t.userId,reference:Object(w.toReference)(t.saveObject),loadSavedTrips:!0,socialReference:Object(O.featureIsEnabled)("social_at_referencing_profile_links")},onCompleted:t.onQueryComplete},function(e){var n=e.data,a=e.loading,r=e.error,i=e.refetch,s=e.fetchMore,l=Object(O.featureIsEnabled)("trips_skip_check_whitelist_public_trips");return C.createElement(G.Query,{skip:l,query:$.GetUserAuthZInfo},function(e){var c,p,u,d=(null==n?void 0:n.paginatedTrips)||{},v=d.trips,m=void 0===v?[]:v,T=d.hasMore,f=void 0===T||T,h=(n||{}).savedTrips,S=void 0===h?[]:h;a?u=C.createElement(W.LoadingSpinner,{size:"large"}):!m&&r&&(u=C.createElement(z.LoadingErrorMessage,{refetch:i}));var b=new Set(S.map(function(e){return e.id}).filter(Boolean)),E=V()({},e),g=l||(null===(c=E.data)||void 0===c?void 0:null===(p=c.authzInfo)||void 0===p?void 0:p.canMakePublicTrip),y={loadingNode:u,tripList:m,saveSet:b,hasMore:f,getMoreTrips:function e(){return s({variables:{offset:(null==m?void 0:m.length)||0,loadSavedTrips:!1},updateQuery:function e(t,n){var a=n.fetchMoreResult;return a?Object.assign({},t,{paginatedTrips:{trips:[].concat(o()(t.paginatedTrips.trips),o()(a.paginatedTrips.trips)),hasMore:a.paginatedTrips.hasMore,__typename:t.paginatedTrips.__typename},savedTrips:t.savedTrips}):t}})},canMakePublicTrip:g};return t.children(y)})})},K=function(e){function t(e){var n;return i()(this,t),n=p()(this,d()(t).call(this,e)),S()(f()(f()(n)),"onModalClose",function(){n.props.onClose(),n.setSplashLoad(!0)}),S()(f()(f()(n)),"clearSplashLoad",function(){n.setSplashLoad(!1)}),n.state={splashLoad:!0},n}return m()(t,e),l()(t,[{key:"setSplashLoad",value:function e(t){this.state.splashLoad!==t&&this.setState({splashLoad:t})}},{key:"render",value:function e(){var t=this,n=Z[this.props.overlayState](),a=C.createElement(Q.TitleBar,{iconName:"suitcase",displayType:"LEFT_ALIGN_GRAY"},n),o=this.props,r=o.loggedInUserId,i=o.saveObject,s=o.modalName,l=o.placement;return C.createElement(B.Modal,{name:s,header:a,isFullBleed:!0,onClose:this.onModalClose},C.createElement(q.Opener,{name:s},function(e,n){return C.createElement(q.Closer,null,function(e){return C.createElement(J,{userId:r,saveObject:i,onQueryComplete:function e(){n&&t.clearSplashLoad()},placement:l||"DEFAULT"},function(n){return n.loadingNode&&t.state.splashLoad?C.createElement("div",{className:"trips-trip-flow-selector-STATModal__loadingContainer--1tP79"},n.loadingNode):t.content(e,n)})})}))}},{key:"content",value:function e(t,n){var a=this,o=this.props,r=o.saveObject,i=o.lastSavedItem,s=o.trackingContext,l=o.onError,c=Object(w.toSavesObject)(i),p=C.createElement(L.TripInteraction,{source:"trips",trackingContext:s,pageAsContext:!0},function(e){return C.createElement("div",{className:"trips-trip-flow-selector-STATModal__modalPadding--36qa6"},C.createElement(Y.CreateTripWithAddItemModal,{object:r,onMount:function t(){n.loadingNode||e({elementClick:{element:"createTrip"}})},onAddedToCreatedTrip:function e(n){a.props.statCallback("ADD","NEW",n,!0,!0),t()},onError:l,canMakePublicTrip:n.canMakePublicTrip}))});switch(this.props.overlayState){case"DEFAULT":return 0===n.tripList.length?p:C.createElement(L.TripInteraction,{source:"trips",trackingContext:s,pageAsContext:!0},function(e){return C.createElement(H.SaveToTripContent,{tripList:n.tripList,savedSet:n.saveSet,tripListBottom:n.loadingNode,onPaginate:n.getMoreTrips,hasMore:n.hasMore,saveObject:r,onMount:function t(){a.props.preventInteractionInMountedComponents||e({elementClick:{element:"stat"}})},onCreateTrip:function e(){a.props.onCreateTripClicked&&a.props.onCreateTripClicked()},tripAction:"SAVE",onRemovedFromTrip:function e(n,o,r){a.props.statCallback("REMOVE","EXISTING",n,o,r),t()},onSavedToTrip:function e(n,o,r){a.props.statCallback("ADD","EXISTING",n,o,r),t()},onError:l,placement:a.props.placement})});case"CREATE":return p;case"SELECT":return c?C.createElement(L.TripInteraction,{source:"trips",trackingContext:s,pageAsContext:!0},function(e){return C.createElement(H.SaveToTripContent,{tripList:n.tripList,savedSet:n.saveSet,tripListBottom:n.loadingNode,onPaginate:n.getMoreTrips,hasMore:n.hasMore,saveObject:c,onMount:function t(){e({elementClick:{element:"stat"}})},onCreateTrip:function e(){a.props.onCreateTripClicked&&a.props.onCreateTripClicked()},tripAction:"MOVE",onMovedToTrip:function e(n,o,r){a.props.statCallback("MOVE","EXISTING",n,o,r),t()},onRemovedFromTrip:function e(n,o,r){a.props.statCallback("REMOVE","EXISTING",n,o,r),t()},onError:l,placement:a.props.placement})}):"";case"SELECT_CREATE":return i?C.createElement("div",{className:"trips-trip-flow-selector-STATModal__modalPadding--36qa6"},C.createElement(Y.CreateTripWithMoveItemModal,{item:i,onMovedToCreatedTrip:function e(n){a.props.statCallback("MOVE","NEW",n,!0,!0),t()},canMakePublicTrip:n.canMakePublicTrip})):p;default:return""}}}]),t}(C.PureComponent);S()(K,"defaultProps",{placement:"DEFAULT"});var ee=K,te=C.createContext(void 0),ne=te.Consumer,ae=te.Provider,oe=function(e){function t(e){var n;return i()(this,t),n=p()(this,d()(t).call(this,e)),S()(f()(f()(n)),"localModalSuffix","".concat(Math.random())),n.state={statProps:null,openCount:0,openModal:function e(){}},n}return m()(t,e),l()(t,[{key:"componentDidUpdate",value:function e(t,n){this.state.openCount>n.openCount&&this.state.openModal()}},{key:"setStatProps",value:function e(t,n){var a=n?{openModal:n,openCount:this.state.openCount+1}:{};this.setState(V()({statProps:t},a))}},{key:"render",value:function e(){var t=this,n=this.state.statProps,a=this.props,o=a.children,r=a.localStats,i=n||r,s=(i||{}).saveObject,l=void 0===s?{}:s,c="save-to-a-trip-modal-".concat(l.id,"-").concat(l.type,"-").concat(this.localModalSuffix),p=null===r?"RemoteStatModal":c;return C.createElement(C.Fragment,null,i&&C.createElement(ee,x()({},i,{modalName:p})),C.createElement(q.Opener,{name:p},function(e){return C.createElement(q.Closer,null,function(n){var a={name:p,open:e,close:n,setStatProps:t.setStatProps.bind(t)};return C.createElement(ae,{value:a},o(a))})}))}}]),t}(C.PureComponent);S()(oe,"defaultProps",{localStats:null});var re=function(e){function t(){var e,n;i()(this,t);for(var a=arguments.length,o=new Array(a),r=0;r<a;r++)o[r]=arguments[r];return n=p()(this,(e=d()(t)).call.apply(e,[this].concat(o))),S()(f()(f()(n)),"remoteProps",null),n}return m()(t,e),l()(t,[{key:"displayChildren",value:function e(t){var n=this;return this.remoteProps=t,this.props.children(t.name,t.close,function e(a){var o=V()({},n.props.statProps,{overlayState:a||n.props.statProps.overlayState});t.setStatProps(o,t.open)}.bind(this))}},{key:"componentDidUpdate",value:function e(t){var n,a,o;(null==t?void 0:null===(n=t.statProps)||void 0===n?void 0:n.overlayState)!==(null===(a=this.props)||void 0===a?void 0:null===(o=a.statProps)||void 0===o?void 0:o.overlayState)&&this.remoteProps&&this.remoteProps.setStatProps(this.props.statProps)}},{key:"render",value:function e(){var t=this;return C.createElement(ne,null,function(e){return e?t.displayChildren(e):C.createElement(oe,{localStats:t.props.statProps},function(e){return t.displayChildren(e)})})}}]),t}(C.PureComponent),ie=["Profile","HomeFeed","Trips","TripsWebview","Home"],se=function(e){function t(e){var n;return i()(this,t),n=p()(this,d()(t).call(this,e)),S()(f()(f()(n)),"launchToast",void 0),S()(f()(f()(n)),"removeToast",void 0),S()(f()(f()(n)),"onComplete",function(e){n.props.onComplete&&n.props.onComplete(e)}),S()(f()(f()(n)),"onModalClose",function(){n.setState({overlayState:"DEFAULT",preventInteractionInMountedComponents:!1})}),S()(f()(f()(n)),"onCreateTripClicked",function(){n.setState({overlayState:"CREATE"})}),S()(f()(f()(n)),"onSelectCreateTripClicked",function(){n.setState({overlayState:"SELECT_CREATE"})}),S()(f()(f()(n)),"onUndoRemoveAction",function(e){n.launchTripToast(Object(N.viewTripToast)(e,"SAVED")),n.setState({overlayState:"DEFAULT"}),n.onComplete(!0)}),S()(f()(f()(n)),"getFirstCommentBody",function(e){var t=e.comments;return t&&t.length>0?t[0].body:null}),S()(f()(f()(n)),"openFlow",function(e,t,a){return function(){var o=Object(w.toSavesObject)(n.props.object);if(o){if(!g.NativeBridge.isNativeWebview()||!g.NativeBridge.isActionSupported("presentSavesModal",2))return a().then(function(){var a=n.getMostRecentlyAddedToTrip();return!n.props.active&&a&&"savesItem"!==o.type?t(a):e(),n.state.overlayState});var r=o.id,i=o.type,s=o.originalObject,l=n.getFirstCommentBody(n.props.object);g.NativeBridge.showSavesModal({id:r,type:i,note:l,originalObject:s&&{type:s.type,id:s.id}})}}}),S()(f()(f()(n)),"onSuccessfulAutosave",function(e,t,a){n.launchTripToast(Object(N.autoSavedToTripToast)(e,function e(){n.setState({overlayState:"SELECT"}),a("SELECT")},n.removeToast)),n.setState({overlayState:"DEFAULT",lastAutosavedItem:t}),n.onComplete(!0)}),S()(f()(f()(n)),"onSuccessfulSave",function(e,t){n.setState({overlayState:"DEFAULT",preventInteractionInMountedComponents:!0}),n.launchTripToast(Object(N.viewTripToast)(e,t)),n.setMostRecentlyAddedToTrip(e.id),n.props.attemptOnboarding&&n.props.setFireOnboarding(!1,"SAVE_ACTION"),n.onComplete(!0)}),S()(f()(f()(n)),"onSaveError",function(e){n.launchTripToast(Object(N.tripsErrorTripToast)(e))}),n.state={overlayState:"DEFAULT",lastAutosavedItem:null,preventInteractionInMountedComponents:!1},n}return m()(t,e),l()(t,[{key:"launchTripToast",value:function e(t){this.launchToast&&this.launchToast.apply(this,o()(t))}},{key:"showUndoRemoveToast",value:function e(t){var n=Object(w.toSavesObject)(this.props.object);n&&this.launchTripToast(Object(N.removeFromTripToast)(t,n,this.props.placement,this.onUndoRemoveAction))}},{key:"setMostRecentlyAddedToTrip",value:function e(t){D.a.set(P.MOST_RECENTLY_ADDED_TO_TRIP,{tripId:t,userId:this.props.loggedInUserId},144e5)}},{key:"getMostRecentlyAddedToTrip",value:function e(){var t=D.a.get(P.MOST_RECENTLY_ADDED_TO_TRIP);return t&&t.userId===this.props.loggedInUserId?t.tripId:null}},{key:"render",value:function e(){var t=this;if(!Object(O.featureIsEnabled)("trips_bookmark"))return null;var n=this.props,a=n.children,o=n.object,r=n.preventInteractionPropagation,i=n.trackingContext,s=n.loggedInUserId,l=n.placement,c=Object(w.toSavesObject)(o);if(!c)return null;var p={modalName:"",saveObject:c,loggedInUserId:s,overlayState:this.state.overlayState,lastSavedItem:this.state.lastAutosavedItem,trackingContext:i,onCreateTripClicked:this.onCreateTripClicked,onClose:this.onModalClose,onError:this.onSaveError,preventInteractionInMountedComponents:this.state.preventInteractionInMountedComponents,statCallback:function e(n,a,o,r,i){"REMOVE"===n?(t.showUndoRemoveToast(o),t.onComplete(i)):"NEW"===a?t.onSuccessfulSave(o,"CREATED"):r&&t.onSuccessfulSave(o,"SAVED")},placement:l};return C.createElement(y.RouteConsumer,null,function(e){var n=e.route;return C.createElement(C.Fragment,null,C.createElement(L.TripInteraction,{source:"trips",trackingContext:i,saveObject:c,pageAsContext:!0},function(e,o){return C.createElement(I.SocialLoginGate,{tracking:{source:"trips",element:"ITEM_SAVE_LOGIN",attributes:{context:n?Object(L.getInteractionsContext)(n.page):void 0,puid:o,saveType:c.type&&c.type.toUpperCase(),detailId:c.id&&"".concat(c.id)}},pid:n&&n.page&&ie.includes(n.page)?40439:39766,flow:"SAVES_COMBINED"},function(o){return C.createElement(re,{statProps:p},function(i,p,u){return C.createElement(C.Fragment,null,C.createElement(_.a,{object:c,onSave:function n(a,o){e({modalSuccess:{element:"quickSave"}}),t.onSuccessfulAutosave(a,o,u)},placement:l,onError:t.onSaveError},function(i){return C.createElement("span",{onClick:function a(o){o.stopPropagation(),o.preventDefault(),!r&&s&&e({elementClick:{element:"item_save"}});var i=t.props.active?"is_saved":"not_saved";A()({action:"saveCTA_click",module:"Trips|".concat(n.page),context:"Trips|".concat(c.type,"|").concat(i)})}},a(t.openFlow(u,i,o)))}))})})}),C.createElement(E.Toaster,null,function(e,n){return t.launchToast=e,t.removeToast=n,null}))})}}]),t}(C.Component);S()(se,"defaultProps",{preventInteractionPropagation:!1,attemptOnboarding:!0,onComplete:void 0,trackingContext:void 0,placement:void 0});var le=Object(b.connect)(function e(t){return{loggedInUserId:t.auth.loggedInUserId}},function e(){return{setFireOnboarding:k.ACTIONS.setShouldFire}})(se),ce=n("@ta/common.logging"),pe=n.n(ce),ue=new(n("@ta/common.state").PrivateStateAccessor)("is-saved-state",{savedMap:{}}),de=function e(t,n){return"".concat(t).concat(n)},ve={updateSaved:function e(t,n,a){return ue.action({type:"UPDATE_SAVED",saveId:t,saveType:n,isSaved:a})}};ue.setReducerIfUnset(function(e,t){var n=e.savedMap,a=t.saveId,o=t.saveType,r=t.isSaved,i=t.type,s=V()({},n);return a&&o&&"UPDATE_SAVED"===i&&(s[de(a,o)]=r),{savedMap:s}});var me=function e(t,n){return!0===t||!1===t?t:n},Te=function e(t){if(!Object(O.featureIsEnabled)("trips_bookmark"))return null;var n=t.object,a=t.preventInteractionPropagation,o=t.trackingContext,r=t.children,i=t.isActive,s=t.updateSaved,l=t.ssr,c=t.placement,p=Object(w.toSavesObject)(n);if(!p)return pe.a.error("An invalid saves object was passed to QueriedTripFlowSelector"),null;var u=Object(w.objectStatisticQuery)(p)||{},d=u&&null==me(i,null);return C.createElement(G.Query,{query:u.query,variables:u.variables,ssr:l,skip:!d,onCompleted:function e(t){if(d){var n=t&&t.savesObjects&&t.savesObjects[0];if(n){var a=function e(t,n){return t===$.LocationStatistics?n.locationId:t===$.AttractionStatistics?n.attractionProductId:n.id}(u.query,n),o=n.socialStatistics,r=void 0===o?{}:o,i=a===p.id&&!!r.isSaved;s(p.id,p.type,i)}}}},function(){return C.createElement(le,{object:n,active:!!i,preventInteractionPropagation:a,trackingContext:o,onComplete:function e(t){s(p.id,p.type,t)},placement:c},function(e){return r(e,!!i)})})};Te.defaultProps={object:null,ssr:!1,trackingContext:void 0};var fe=Object(b.connect)(function(e,t){var n=function e(t,n){var a=n?de(n.id,n.type):"";return ue.getFrom(t).savedMap[a]}(e,Object(w.toSavesObject)(t.object)),a=function e(t){return t&&t.socialStatistics&&t.socialStatistics.isSaved}(t.object),o=me(n,a);return{loggedInUserId:e.auth.loggedInUserId,isActive:o}},{updateSaved:ve.updateSaved})(Te);n.d(t,"TripFlowSelector",function(){return le}),n.d(t,"QueriedTripFlowSelector",function(){return fe}),n.d(t,"RemoteSTATModalProvider",function(){return oe})}}});
//# sourceMappingURL=trips.trip-flow-selector.2d55e8d944.js.map